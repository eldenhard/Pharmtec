<template>
    <div>
        <div class="lkpage_wrapper">
            <div class="grey_container">
                <svg viewBox="0 0 1611 730" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M995.781 129.102C976.678 48.9753 992.838 -31.2301 1046.53 -85.4277C1137.88 -177.56 1303.76 -159.769 1417.09 -45.622C1420.27 -42.3214 1423.42 -39.0078 1426.42 -35.7083C1338.35 -65.74 1228.27 -54.5614 1129.62 3.06802C1072.86 36.2132 1027.52 80.1329 995.781 129.102Z"
                        stroke="#DFDFDF" />
                    <path
                        d="M1288.26 485.725C1209.11 504.992 1129.81 488.661 1076.16 434.393C984.973 341.994 1002.44 174.394 1115.53 59.8721C1118.73 56.6692 1121.92 53.4865 1125.19 50.3655C1095.54 139.446 1106.6 250.764 1163.6 350.422C1196.25 407.643 1239.82 453.703 1288.26 485.725Z"
                        stroke="#DFDFDF" />
                    <path
                        d="M1335.27 -184.986C1414.54 -204.234 1493.78 -187.967 1547.41 -133.626L1547.77 -133.978L1547.41 -133.626C1638.58 -41.2635 1621.03 126.352 1508.05 240.931C1506.91 242.041 1505.78 243.151 1504.65 244.257C1502.54 246.324 1500.44 248.375 1498.35 250.379C1527.91 161.354 1516.94 50.0227 1459.95 -49.6688C1427.28 -106.964 1383.67 -152.854 1335.27 -184.986Z"
                        stroke="#DFDFDF" />
                    <path
                        d="M1206.57 349.6L1206.57 349.597C1203.35 346.415 1200.17 343.028 1197.13 339.673C1285.06 369.784 1395.16 358.604 1493.91 301.003C1550.61 267.946 1595.89 223.919 1627.85 174.974C1646.74 255.12 1630.75 335.299 1577.02 389.405L1577.02 389.406C1485.8 481.643 1319.81 463.919 1206.57 349.6Z"
                        stroke="#DFDFDF" />
                    <path
                        d="M179.123 567.099V567.102C179.154 585.447 184.911 603.347 195.629 618.427C206.337 633.491 221.488 645.028 239.074 651.509C244.416 654.919 248.779 661.092 252.309 669.603C255.846 678.131 258.525 688.956 260.523 701.571C264.519 726.8 265.777 759.109 265.777 794.353C265.777 830.494 264.438 863.485 260.189 888.932C258.064 901.656 255.216 912.471 251.457 920.842C247.702 929.204 243.064 935.071 237.387 938.006C217.882 944.922 201.484 958.292 191.059 975.788C180.887 992.859 177.032 1012.8 180.109 1032.28C79.3319 935.505 32.7287 809.759 11.3306 708.036C0.593947 656.996 -3.79468 612.015 -5.49908 579.795C-6.35126 563.685 -6.53237 550.767 -6.5005 541.877C-6.48457 537.432 -6.4154 533.995 -6.35025 531.669C-6.31768 530.507 -6.28611 529.622 -6.26271 529.028C-6.25312 528.785 -6.2449 528.591 -6.23855 528.446C-6.08063 528.38 -5.8575 528.287 -5.56955 528.169C-4.9311 527.908 -3.97396 527.523 -2.70225 527.033C-0.158821 526.052 3.64289 524.648 8.67 522.957C18.7242 519.574 33.6799 515.041 53.274 510.448C92.1337 501.339 149.237 491.992 222.532 490.901C209.564 498.828 198.805 509.77 191.228 522.757C183.342 536.274 179.172 551.548 179.123 567.099Z"
                        stroke="#DFDFDF" />
                    <path
                        d="M472.076 517.153L472.079 517.154C535.566 530.615 594.983 558.2 645.693 597.736C629.764 593.04 612.808 592.645 596.639 596.616C579.587 600.805 564.125 609.675 552.092 622.175C540.059 634.675 531.96 650.28 528.76 667.135C525.643 683.551 527.301 700.48 533.531 716.011L533.081 716.33C535.829 722.244 535.233 729.825 531.776 738.848C528.322 747.863 522.043 758.233 513.559 769.655C496.592 792.497 470.879 819.454 441.561 848.051C412.243 876.647 384.52 901.692 361.023 918.204C349.274 926.461 338.604 932.567 329.336 935.922C320.059 939.279 312.266 939.851 306.209 937.161L305.812 937.74C300.387 934.709 295.929 928.952 292.297 920.866C288.538 912.496 285.69 901.685 283.565 888.965C279.316 863.525 277.977 830.543 277.977 794.386C277.977 759.142 279.235 726.833 283.235 701.604C285.235 688.989 287.917 678.164 291.458 669.636C294.993 661.125 299.362 654.952 304.712 651.543C320.36 645.809 334.12 636.047 344.528 623.295C354.947 610.529 361.614 595.245 363.817 579.073C366.019 562.902 363.674 546.451 357.033 531.478C350.637 517.058 340.487 504.529 327.605 495.124C376.193 499.465 424.449 506.823 472.076 517.153Z"
                        stroke="#DFDFDF" />
                    <path
                        d="M712.931 689.115C713.447 678.145 711.877 667.185 708.309 656.786C791.819 753.01 832.011 878.031 851.314 979.3C861.032 1030.28 865.453 1075.23 867.445 1107.43C868.441 1123.53 868.83 1136.44 868.969 1145.33C869.039 1149.77 869.046 1153.21 869.037 1155.54C869.032 1156.7 869.022 1157.58 869.014 1158.18C869.011 1158.38 869.009 1158.56 869.007 1158.69C868.845 1158.73 868.63 1158.79 868.364 1158.85C867.693 1159.02 866.693 1159.26 865.378 1159.57C862.748 1160.19 858.857 1161.09 853.818 1162.18C843.739 1164.35 829.066 1167.3 810.695 1170.39C774.409 1176.48 723.697 1183.12 665.459 1185.42C680.503 1177.28 692.934 1165.2 701.329 1150.53C710.086 1135.23 714.072 1117.77 712.798 1100.29C711.523 1082.81 705.043 1066.07 694.153 1052.13C683.278 1038.21 668.476 1027.67 651.558 1021.82C646.543 1018.36 642.449 1012.6 639.135 1004.9C635.81 997.176 633.287 987.542 631.403 976.419C627.634 954.171 626.432 926.038 626.432 895.48C626.432 864.922 627.618 836.868 631.35 814.679C633.217 803.585 635.717 793.975 639.013 786.26C642.298 778.572 646.358 772.802 651.333 769.303C662.822 765.45 673.409 759.405 682.474 751.52C691.558 743.619 698.932 734.029 704.163 723.313C709.393 712.596 712.374 700.97 712.931 689.115Z"
                        stroke="#DFDFDF" />
                </svg>


                <div class="grid_lk">
                    <div class="f_line">
                        <h4>{{ _user_data?.last_name || 'Фамилия' }} {{ _user_data?.first_name || 'Имя' }} {{
                            _user_data?.middle_name || 'Отчество' }}</h4>
                        <p style="display: flex; align-items: center; gap: 2%;" v-if="editUserProfile">
                            <i class="bi bi-circle-fill" style="font-size: 1vh !important;"
                                :class="currentColorClass"></i>
                            <span style="color: #7F7F7F;">
                                {{ _user_data?.status || "Работает" }}
                            </span>
                        </p>
                        <select name="" id="" v-else v-model="user_status_change">
                            <option value="Больничный">Больничный</option>
                            <option value="Командировка">Командировка</option>
                            <option value="Отпуск">Отпуск</option>
                            <option value="Работает">Работает</option>
                        </select>
                        <a style="color: #14949C" @click="editUserProfile = !editUserProfile">{{ !editUserProfile ?
                            'Сохранить' : 'Редактировать' }}</a>
                    </div>
                    <div class="s_line">
                        <div class="img_block">
                            <div class="img_block_img">
                                <img src="./assets/team-img-8.jpg" alt="фото сотрудника">
                            </div>

                            <div class="img_block_description">
                                <p>Email: <span>{{ _user_data?.email }}</span></p>
                                <p>тел: <span>{{ _user_data?.phone }}</span></p>
                            </div>
                        </div>
                        <div class="information_block">
                            <div class="information_block_top_block">
                                <div>
                                    <p>Должность: <span>{{ _user_data?.job_info?.name }}</span></p>
                                    <p>Подразделение: <span></span></p>
                                    <p>Город: <span></span></p>
                                </div>
                                <div>
                                    <p>День рождения: <span>{{ _user_data?.birth_date?.split("-").reverse().join('.')
                                            }}</span></p>
                                    <p>Стаж работы: <span></span></p>
                                </div>
                            </div>
                            <hr>
                            <div class="information_block_top_block_bottom_block">
                                <div>
                                    <p>Отдел: <span></span></p>
                                    <p>Руководитель <span></span></p>
                                    <p>Заменяющий:
                                        <span v-if="editUserProfile">{{ _user_data?.vice_info }}</span>
                                        <v-select v-model="substitute_person" :options="all_users" label="full_name"
                                            v-else required style="width: 20vw;" />
                                    </p>
                                </div>
                                <div>
                                    <p>Формат работы: <span></span></p>
                                    <p>Юридическое лицо: <span>{{ _user_data?.company }}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- <SidebarLk @currentActiveTab="received_data = $event" />
            <Transition name="fade" mode="out-in" appear>
                <WorkspaceLk :key="received_data">
                    <component :is="received_data" />
    
                </WorkspaceLk>
            </Transition> -->
        </div>
        <Footer />
    </div>
</template>


<script>
import api from '@/api/user'
import { ref, onBeforeMount, onMounted, onBeforeUpdate, computed, watch } from 'vue'
import SidebarLk from './components/SidebarLk.vue'
import WorkspaceLk from './components/WorkspaceLk.vue'
import UserStatus from './modules/UserStatus.vue'
import { useCurrentUserId } from '@/store/CurrentUserId.js'
import { useLoaderStore } from '@/store/LoaderStore'
import { refreshToken } from '@/mixins/refreshToken'
import { useToast } from "vue-toastification";

import { storeToRefs } from 'pinia'

import Footer from "@/pages/new_start_page/components/footer.vue"
export default {
    components: {
        SidebarLk,
        WorkspaceLk,
        UserStatus,
        Footer,
    },
    setup() {
        const received_data = ref('');
        const $toast = useToast()
        const _user_data = ref("")
        const editUserProfile = ref(true)
        const substitute_person = ref('')
        const all_users = ref([])
        const user_status_change = ref('')


        const $STORE = useCurrentUserId()
        const { current_user_id } = storeToRefs($STORE)

        onMounted(async () => {
            let id = localStorage.getItem('id')
            useLoaderStore().setLoader(true)
            await refreshToken()
            try {
                let user_obj = await api.getFullDataUserById(id)
                _user_data.value = user_obj.data
                // let user_by_id = await api.getUserById(current_user_id.value)
                // current_user.value = user_by_id.data
                // full_name_current_user.value = `
                //     ${user_by_id.data.last_name || ""} 
                //     ${user_by_id.data.first_name || ""} 
                //     ${user_by_id.data.middle_name || ""} 
                //     ${user_by_id.data.email || ""}
                // `.trim()

                let response = await api.getAllUsers()
                all_users.value = response.data.reduce((acc, el) => {
                    let full_name = `${el.last_name} ${el.first_name} ${el.middle_name}`
                    return [...acc, { ...el, full_name }]
                }, []).sort((a, b) => a.full_name.localeCompare(b.full_name))
                // $toast.success("Пользователи загружены", {
                //     timeout: 2000
                // })
            } catch (err) {
                $toast.error(`Произошла ошибка при загрузке пользователей\n ${err.response}`, {
                    timeout: 3000
                })
                console.log(err)
            } finally {
                useLoaderStore().setLoader(false)
            }

        })

        const currentColorClass = computed(() => {
            switch (_user_data.value.status) {
                case 'Больничный':
                    return 'red'
                    break
                case 'Отпуск':
                    return 'blue'
                    break
                case 'Командировка':
                    return 'turquoise'
                    break
                default:
                    return 'green'
                    break
            }
        })
        watch(editUserProfile, async (newVal) => {
            if (newVal === true) {
                await handleUserProfileChange();
            }
        });
        watch(user_status_change, () => {
            if (user_status_change.value === "Работает") {
                substitute_person.value = ""
            }
        })
        const handleUserProfileChange = async () => {
            try {
                useLoaderStore().setLoader(true);
                await refreshToken()
                let queryParams;
                if (user_status_change.value === "Работает") {
                    queryParams = { status: user_status_change.value, vice: "" };
                  
                } else {
                    queryParams = { status: user_status_change.value, vice: substitute_person.value.id };
                }

                await api.putUserById(current_user_id.value, queryParams);
                let id = localStorage.getItem('id')
    
                let user_obj = await api.getFullDataUserById(id);
                _user_data.value = user_obj.data;
                $toast.success("Статус пользователя изменен", {
                    timeout: 3500
                });
            } catch (err) {
                $toast.error(`Ошибка!\nСтатус пользователя не изменен\n${err.response.data}`, {
                    timeout: 3500
                });
            } finally {
                useLoaderStore().setLoader(false);
            }
        };


        return {
                received_data,
                currentColorClass,
                _user_data,
                editUserProfile,
                substitute_person,
                all_users,
                user_status_change,

            }
        },
    }
</script>


<style scoped>
@import './style/styles.scss';
</style>
